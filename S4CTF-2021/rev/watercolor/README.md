# WaterColor

## info

been given an apk file... I used jadx for unpacking and decompilation and etc...

names were a bit obfuscated... there was 6 java files at `sources/io/peykar/watercolor/` which one was a utility for ssl pinning...

an asset file at `resources/assets/uw7289nv` holding this value `r6EszdHWf8TkNrC+BLfiXILGelpBPHw7koCOeLpBv8w=`

running the apk in an emulator, it requires a username and a password...

here we get to read source files... I've renamed some stuff and edited codes a bit for convenience...

file `sources/io/peykar/watercolor/bj9704hd.java` corresponds for handling that:

```java
public class bj9704hd extends Fragment {
    String g_str_username;
    String g_str_password;

    public native void extraInfo();

    public native byte[] initFromJNI();

    static {
        System.loadLibrary("native-lib");
    }

    public void onCreate(Bundle bundle) {
        super.onCreate(bundle);
    }

    public View onCreateView(LayoutInflater layoutInflater, ViewGroup viewGroup, Bundle bundle) {
        View inflate = layoutInflater.inflate(R.layout.fragment_login, viewGroup, false);
        final EditText editText = (EditText) inflate.findViewById(R.id.usernametext);
        final EditText editText2 = (EditText) inflate.findViewById(R.id.passwordtext);
        ((Button) inflate.findViewById(R.id.loginbtn)).setOnClickListener(new View.OnClickListener() {
            public void onClick(View view) {
                bj9704hd.this.g_str_username = editText.getText().toString();
                bj9704hd.this.g_str_password = editText2.getText().toString();
                if (bj9704hd.this.g_str_username.matches("") || bj9704hd.this.g_str_password.matches("")) {
                    Toast.makeText(bj9704hd.this.getActivity().getApplicationContext(), "Username and Password are required", 0).show();
                } else if (new LocalCipherManager().check_password_wr9452tb(bj9704hd.this.g_str_password)) {
                    bj9704hd.this.extraInfo();
                    SharedPreferences.Editor edit = bj9704hd.this.getActivity().getSharedPreferences("watercolor", 0).edit();
                    edit.putString("password", bj9704hd.this.g_str_password);
                    edit.commit();
                    bj9704hd.this.getActivity().getSupportFragmentManager().beginTransaction().replace(R.id.fragment_container, new nt9923ng()).addToBackStack("main").commit();
                } else {
                    Toast.makeText(bj9704hd.this.getActivity().getApplicationContext(), "Incorrect Username or Password", 0).show();
                }
            }
        });
        return inflate;
    }

    class LocalCipherManager {
        Cipher uh7608nh;

        public LocalCipherManager() {
            try {
                MessageDigest instance = MessageDigest.getInstance("SHA-256");
                byte[] initFromJNI = bj9704hd.this.initFromJNI();
                instance.update(initFromJNI, 0, initFromJNI.length);
                SecretKeySpec secretKeySpec = new SecretKeySpec(instance.digest(), "AES");
                Cipher instance2 = Cipher.getInstance("AES");
                this.uh7608nh = instance2;
                instance2.init(1, secretKeySpec);
            } catch (NoSuchAlgorithmException e) {
                e.printStackTrace();
            } catch (InvalidKeyException e2) {
                e2.printStackTrace();
            } catch (NoSuchPaddingException e3) {
                e3.printStackTrace();
            }
        }

        public String fg8461gs(String str) {
            try {
                return Base64.encodeToString(this.uh7608nh.doFinal(str.getBytes()), 2);
            } catch (BadPaddingException e) {
                e.printStackTrace();
                return "";
            } catch (IllegalBlockSizeException e2) {
                e2.printStackTrace();
                return "";
            }
        }

        public boolean check_password_wr9452tb(String str) {
            try {
                String readLine = new BufferedReader(new InputStreamReader(bj9704hd.this.getActivity().getAssets().open("uw7289nv"))).readLine();
                if (readLine == null || !readLine.equals(fg8461gs(str))) {
                    return false;
                }
                return true;
            } catch (IOException e) {
                e.printStackTrace();
                return false;
            }
        }
    }
}
```

as you can see, it doesn't care about username just needs it not to be empty...

and encrypts the given password by AES with a key generated by a call to a native function called `initFromJNI`...
then compares its base64 to the content of that asset mentioned earlier...

considering we get the password, then what?

then it gets us to a puzzle game... which I didn't read the corresponding code because I found something better...

file `sources/io/peykar/watercolor/kj0762ey.java` has an interesting method:

```java

    private void solvedPuzzleUI() {
        LinearLayout linearLayout = (LinearLayout) this.hd9863mm.findViewById(R.id.pauseContainer);
        getLayoutInflater().inflate(R.layout.puzzle_solved_ui, linearLayout, true);
        linearLayout.setClickable(true);
        linearLayout.setVisibility(0);
        ((Button) this.hd9863mm.findViewById(R.id.okBtn)).setOnClickListener(new View.OnClickListener() {
            public void onClick(View view) {
                new Thread(new Runnable() {
                    public void run() {
                        try {
                            URI uri = new URI(kj0762ey.this.ss2176jv.getResources().getString(R.string.hostname));
                            OkHttpClient unused = kj0762ey.this.fs9572kw = se5498vr.ab3702ns(uri.getHost(), kj0762ey.this.ss2176jv.getResources().getString(R.string.fingerprint));
                            String string = kj0762ey.this.gs0973mt.getString("password", "");
                            JSONObject jSONObject = new JSONObject();
                            try {
                                jSONObject.put("username", "find a valid username to capture the flag");
                                jSONObject.put("password", string);
                                kj0762ey.this.fs9572kw.newCall(new Request.Builder().url(uri.toURL()).post(RequestBody.create(kj0762ey.this.yh5921pa, jSONObject.toString())).build()).enqueue(new Callback() {
                                    public void onFailure(Call call, IOException iOException) {
                                        Log.i("watercolor", "Failure in sending request");
                                        iOException.printStackTrace();
                                    }

                                    public void onResponse(Call call, Response response) {
                                        Log.i("watercolor", "Response received successfully");
                                    }
                                });
                            } catch (JSONException e) {
                                e.printStackTrace();
                            }
                        } catch (Exception e2) {
                            e2.printStackTrace();
                        }
                    }
                }).start();
                kj0762ey.this.getActivity().getSupportFragmentManager().popBackStack();
                kj0762ey.this.getActivity().getSupportFragmentManager().beginTransaction().replace(R.id.fragment_container, new bj9704hd()).addToBackStack("login").commit();
            }
        });
        ((Button) this.hd9863mm.findViewById(R.id.newButton)).setOnClickListener(new View.OnClickListener() {
            public void onClick(View view) {
                kj0762ey.this.getActivity().getSupportFragmentManager().popBackStack();
                kj0762ey.this.getActivity().getSupportFragmentManager().beginTransaction().replace(R.id.fragment_container, new nt9923ng()).addToBackStack("login").commit();
            }
        });
        ((TextView) this.hd9863mm.findViewById(R.id.puzzleDataView)).setText(String.format(Locale.getDefault(), "Puzzle Solved  ðŸ˜Ž", new Object[0]));
    }
```

url is in `resources/res/values/strings.xml`:
```
    <string name="hostname">https://water-color.peykar.io</string>
```

the password is taken from sharedPreferences which is put by last file we saw that checked the password...

the username... it tells you must find it by yourself... well... sure...

it is generated by the other native function `extraInfo`...

the library for these function was at `resources/lib/x86_64/libnative-lib.so`...

## solution

opening the library with cutter, the decompiled code wasn't helping much and it was a bit complex... so I decided to for dynamic analysis and use frida...

I used this python script to get the aes key...:
```python
import sys

import frida


jscode = """
console.log("Script loaded successfully ");
Java.perform(function x() {
    console.log("Inside java perform function");

    //Find an instance of the class and call "secret" function.
    Java.choose("io.peykar.watercolor.bj9704hd", {
        onMatch: function (instance) {
            console.log("Found instance: " + instance);

            var ret = instance.initFromJNI();
            var buffer = Java.array('byte', ret);

            var result = "";
            for(var i = 0; i < buffer.length; ++i){
                result+= (String.fromCharCode(buffer[i]));
            }

            console.log("password is: " + result);

        },
        onComplete: function () { }
    });
});
"""

process = frida.get_usb_device().attach('io.peykar.watercolor')
script = process.create_script(jscode)
print('[*] Loading script...')
script.load()

sys.stdin.read()
```
just have frida-server running as root in your emulator, and run the script, you get the key...

for username, we can't get it by just calling it... that function write the generated username string to android debug output...
```c
code_r0x00016465:
    *(undefined *)(iVar7 + uVar10) = 0;
    __android_log_print(4, "watercolor", "valid username is: %s", iVar7);
    if (*(int64_t *)(in_FS_OFFSET + 0x28) == iStack48) {
        return;
    }
    // WARNING: Subroutine does not return
    __stack_chk_fail();
}
```

so I used adb logcat and grep, called the function by slightly modifying last script, and got the username:
```python
import sys

import frida


jscode = """
console.log("Script loaded successfully ");
Java.perform(function x() {
    console.log("Inside java perform function");

    //Find an instance of the class and call "secret" function.
    Java.choose("io.peykar.watercolor.bj9704hd", {
        onMatch: function (instance) {
            console.log("Found instance: " + instance);

            instance.extraInfo();
        },
        onComplete: function () { }
    });
});
"""

process = frida.get_usb_device().attach('io.peykar.watercolor')
script = process.create_script(jscode)
print('[*] Loading script...')
script.load()

sys.stdin.read()
```

finally... to retrieve the flag... used this script to decrypt the password and make an api request to get the flag:
```python
import base64
import hashlib
from Crypto import Random
from Crypto.Cipher import AES

import requests

AES_KEY = "MfVLoHWWiAyeaTl"
ENC_PASS = "r6EszdHWf8TkNrC+BLfiXILGelpBPHw7koCOeLpBv8w="


class AESCipher(object):

    def __init__(self, key):
        self.bs = AES.block_size
        self.key = hashlib.sha256(key.encode()).digest()

    def encrypt(self, raw):
        raw = self._pad(raw)
        iv = Random.new().read(AES.block_size)
        cipher = AES.new(self.key, AES.MODE_CBC, iv)
        return base64.b64encode(iv + cipher.encrypt(raw.encode()))

    def decrypt(self, enc):
        enc = base64.b64decode(enc)
#        iv = enc[:AES.block_size]
        cipher = AES.new(self.key, AES.MODE_ECB)
        return self._unpad(cipher.decrypt(enc[:]))

    def _pad(self, s):
        return s + (self.bs - len(s) % self.bs) * chr(self.bs - len(s) % self.bs)

    @staticmethod
    def _unpad(s):
        return s[:-ord(s[len(s)-1:])]


def brute_sha256(target):
    pass


if __name__ == '__main__':
    password = AESCipher(AES_KEY).decrypt(ENC_PASS)

    params = {
        'username': '!@W@t3RC^l3r&$3cr3t!U53R#',
        'password': password.decode('utf-8')
    }
    res = requests.post('https://water-color.peykar.io', json=params)

    print(res.json())
```
